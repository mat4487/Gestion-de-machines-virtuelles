\chapter{Installation de virt-manager}
\section{Pré-requis et considérations pour les hôtes}
Divers facteurs doivent être considérés avant de créer des hôtes virtualisés.
\subsubsection{Performance} 
Les hôtes virtualisés doivent être déployé et configuré en fonction de leurs tâches prévues. Certains systèmes (par exemple, les hôtes ou sont hébergés des serveur de base de données) ont besoin de performances plus élevées que d'habitude; Les hôtes peuvent exiger plus de CPU ou de mémoire attribué en fonction de leur rôle,et de l'utilisation futur qu'il pourrait avoir. projeté la charge du système.
\subsubsection{Stockage}
Certains hôtes peuvent avoir besoin d'une plus grande priorité d'accès au stockage, de disques plus rapides, ou peuvent exiger un accès exclusif à des zones de stockage. La quantité de stockage utilisée par les hôtes doit être régulièrement surveillée et prise en compte lors du déploiement et le maintien de stockage.
\subsubsection{Mise en réseau et l'infrastructure du réseau}
 En fonction de notre environnement, certains hôtes pourraient exiger des liens réseau plus rapides que d'autres hôtes. La bande passante ou de latence sont souvent des facteurs à prendre en compte lors du déploiement et le maintenance des hôtes.
\section{Installation côté serveur}
Cette partie est facile, un simple apt-get install suffit. Nous installons le paquet qui communique avec Xen et remonte les informations au client virt-manager.
\begin{lstlisting}
apt-get install libvirt-bin
\end{lstlisting} 
Du coté de Xen, nous devons vérifier qu’il peut communiquer avec libvirt.

Libvirt accède aux données de Xen via un socket unix. La configuration consiste à activer cette option dans Xen et à relancer les services.
Nous éviterons ainsi l’erreur libvirtError: internal error failed to connect to xend dont on trouve peu d’explication sur le net.

On édite le fichier de configuration xen
\begin{lstlisting} 
nano /etc/xen/xend-config.sxp
\end{lstlisting}
 on active la ligne suivante
\begin{lstlisting} 
(xend-unix-server yes)
\end{lstlisting}
 Enfin on relance le service xen avec /etc/init.d/xend restart

\section{Installation côté client}
Pour gérer nos serveurs, nous installons virt-manager avec la commande suivante:
\begin{lstlisting} 
apt-get install virt-manager
\end{lstlisting}
Virt-manager étant un outil graphique, ses fichiers de configurations sont gérés par gconf. Ainsi, pour automatiser l'ajout des différents noeuds nous avons crée un script qui réécrit le fichier \emph{~/.gconf/apps/virt-manager/connections/\%gconf.xml}
\begin{lstlisting}
for node in $(cat $list_nodes)
do
    echo '<li type="string">' >> $fichier
    echo "<stringvalue>xen+ssh://root@$node/</stringvalue>" >> $fichier
    echo '</li>' >> $fichier
done
\end{lstlisting}
Ce fichier est au format xml et contient pour chaque noeud une entrée. Ici, les connexions sont gérées au-dessus d'un tunnel ssh.
\section{Création d'hôtes virtualisés avec virt-manager}
1)Pour commencer on démarre virt-manager, puis on lance le gestionnaire de machines virtuelles à partir du menu en cliquant sur l'icone en forme de pc.

%\begin{figure}
\begin{center}
\includegraphics[width=350pt]{images/virt.jpg}
\end{center}
%\caption{Interface de virt-manager}
%\end{figure}

3) La fenêtre du gestionnaire de machine virtuelle nous autorise à en créer de nouvelles.
On clique sur création de nouvelle machine virtuelle pour faire apparaître l'assistant qui va nous aider pour élaborer notre hôte.
L'assistant décompose la création en cinq étapes:
-La localisation et la configuration des supports d'installation
-La configuration de la mémoire et les options de CPU
-La configuration du stockage de l'invité
-La configuration réseau, l'architecture, et d'autres paramètres matériels

Le processus de création d'hôte commence avec la selection d'un nom et le type d'installation.
%\begin{figure}
\begin{center}
\includegraphics[width=350pt]{images/nommachine.jpg}
\end{center}
%\caption{Choix du nom de la nouvelle machine virtuelle}
%\end{figure}
-Local install media(ISO image or CDROM)
Cette méthode utilise un CD-ROM,DVD ou une image iso.

-Network install
Cette méthode utilise le réseau pour installer le système d'exploitation.

-Import existing disk image
Cette méthode nous permet de créer un nouvelle hôte et d'y importer une image disque.

La prochaine étape consiste à configurer l'installation.
On configure le type de système d'exploitation et sa version qui sera installé, cela dépend de la méthode d'installation que l'on a choisie.
%\begin{figure}
\begin{center}
\includegraphics[width=300pt]{images/iso.jpg}
\end{center}
%\caption{Choix du nom de la nouvelle machine virtuelle}
%\end{figure}

Configuration du CPU et de la mémoire
La prochaine étape consiste à configurer le nombre de CPU et la quantité de mémoire à allouer à la machine virtuelle. L'assistant indique le nombre de processeurs et la quantité de mémoire que l'on peut lui allouer.
%\begin{figure}
\begin{center}
\includegraphics[width=300pt]{images/cpu.jpg}
\end{center}
%\caption{Configuration du CPU et de la mémoire allouée à la machine virtuelle}
%\end{figure}

Configuration de l'espace de stockage
%\begin{figure}
\begin{center}
\includegraphics[width=300pt]{images/Storage.jpg}
\end{center}
%\caption{Choix du stockage de la machine virtuelle}
%\end{figure}

 Si l'on a choisi d'importer une image de disque existante au cours de la première étape, virt-manager va sauter cette étape.
On doit attribuer un espace suffisant pour notre machine virtuelle et toutes les applications que l'hôte a besoin.

Configuration finale
On vérifie les paramètres de la machine virtuelle et on clique sur Terminer lorsqu'on est satisfait, cela permettra de créer l'hôte avec les paramètres réseau par défaut, le type de virtualisation, et l'architecture.
\begin{center}
\includegraphics[width=300pt]{images/reseau.jpg}
\end{center}
%\caption{Configuration du réseau}


\subsection{Controle d'hotes distants}
On peut facilement manager des hotes distants une fois ceux-ci enregistrés dans virt-manager. Cette opération peut être fastidieuse car virt étant un programme graphique, crée un script pour automatiser l'ajout de plusieurs dizaines de noeuds s'est avéré plus compliqué que prévu.
Cherchant désespérément un fichier de configuration, nous avons fini par le trouver en lançant une recherche dans tout le système sur les noms des noeuds ajoutés à virt. Le fichier est donc géré par \emph{gconf} en voici un exemple
\lstinputlisting[language=xml,morekeywords={li,entry,stringvalue,gconf}]{scripts/virt-manager/gconf.xml}
Après l'installation de virt, le seul lien enregistré est le lien local. Pour ajouter une connexion vers un nouvel hote xen, on peut utiliser l'interface graphique.
%\includegraphics image ajout d'un noeud
Cependant, dans notre cas, il était assez fastidieux de renseigner manuellelement chacun des noeuds surtout lors des tests à grande échelle. C'est pourquoi nous avons fait un script (voir annexe \ref{ajout-noeuds} en page \pageref{ajout-noeuds}) donc voici la boucle d'ajout des noeuds:
\begin{lstlisting}[language=bash]
#Pour chaque noeud réservé, on ajoute une entrée dans le fichier
for node in $(cat $list_nodes)
do
    echo '<li type="string">' >> $fichier
    echo "<stringvalue>xen+ssh://root@$node/</stringvalue>" >> $fichier
    echo '</li>' >> $fichier
done
\end{lstlisting}
Le script de base ayant configuré chacun des noeuds de la même manière, ils peuvent tous être utilisés pour gérer l'ensemble du réseau, une fois le script exécuté.
\begin{center}
  \includegraphics[width=300pt]{images/virt-ajout_noeuds.png}
\end{center}
Un simple clic sur un noeud établit la connexion puisque les mêmes clefs ssh ont étées copiées partout et le fichier \emph{known\_hosts} a également été répliqué pour éviter de confirmer l'ajout d'un hôte inconnue (opération qui devait se faire en ligne de commande car non gérée par virt).
\\
On est ensuite en mesure de créer une machine sur n'importe quel noeud, la procédure étant la même que pour une installation locale, nous n'allons pas la détailler à nouveau.

\subsubsection{Migration de machines}
Une fonctionnalité intéressate d'un gestionnaire de machines virtuelles est la migration des systèmes invités vers un autre hôte pour prévoir des opérations de maintenance, remplacement,...\\
Encore une fois virt-manger possède un outil graphique afin d'assister cette étape. Pour commencer, en effectuant un click droit sur une machine virtuelle on obitent un menu contextuel que nous allons détaillé au fur et à mesure.
\begin{center}
  \includegraphics[width=350pt]{images/virt-menu-context.png}
\end{center}
En sélectionnant l'option \emph{Migrate} l'assistant demande alors sur quel autre noeud (préalamblement ajouté à virt) nous souhaitons transférer la machine virtuelle. L'opération peut prendre plusieures minutes en fonctions des capacités des machines et du réseau.
\begin{center}
  \includegraphics[width=250pt]{images/migration.png}
\end{center}
